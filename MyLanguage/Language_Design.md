## 现代通用编程语言：从0到1技术选型与落地路线

本文档用于沉淀“现代化、完整、独立”的通用编程语言从0到1的技术选型与路线规划，面向 Python / Rust / Go 同级定位。目标：可用于通用开发，具备自有工具链、运行时、标准库、包管理与跨平台能力。

## 愿景与范围

- **愿景**: 提供开发者友好、性能可预期、工具链完善、可跨平台分发的现代语言。
- **范围**: 语言规范、编译/执行管线、运行时、标准库、工具链、包管理、生态分发与安全策略。

## 总体架构与阶段性目标

- **执行路线**: 解释器 → 字节码 VM → AOT（C 后端优先，可选 LLVM）并行支持 WASM。
- **内存模型**: 初期 GC（标记-清扫），后续分代/并发/区域优化。
- **类型系统**: 静态类型 + 局部推断 + 泛型（初期字典传递，成熟后单态化）。
- **并发模型**: CSP 风格（协程/通道/选择）+ async/await 语法糖。
- **错误处理**: 以 Result/Option 为核心，`?` 传播；异常仅用于不可恢复错误与跨边界桥接。
- **后端目标**: AOT 生成 C 源码（最小可行跨平台），可选 LLVM（AOT/JIT），并行 WASM（WASI）。
- **互操作**: C ABI 优先；提供 `extern` 绑定与自动绑定生成工具（中期）。

## 语言规范（设计基线）

- **语法风格**: C/Go 风格块结构，少关键字，语义直观。
- **模块系统**: 包/模块与命名空间；明确可见性；单一导入语义。
- **类型系统**: 静态类型，类型推断，代数数据类型（ADT），泛型，接口/trait 类能力（后期可做）。
- **并发语义**: 轻量协程、通道、选择（select），背后有可插拔调度器。
- **错误语义**: Result/Option + 模式匹配；异常为宿主/FFI 桥接与崩溃信号。
- **内存语义**: GC 管理堆；可选 RAII/`defer` 风格资源释放协议接口。

## 编译与执行管线（高层）

- **前端**: 词法分析 → 语法分析 → AST 构建 → 语义分析/类型检查。
- **中间层**: 中间表示（IR/字节码）生成与轻量优化（常量折叠、死代码删除、内联等分期推进）。
- **后端（阶段化）**:
  - 阶段1: 解释执行（AST 或简易 IR），快速迭代语义与错误模型。
  - 阶段2: 字节码 VM（栈机或寄存器机，建议寄存器机以利于优化）。
  - 阶段3: AOT 生成 C 源码并用 clang/gcc 链接；并行评估 LLVM AOT 与 WASM 目标。

## 核心技术选型

- **解析**: ANTLR4（C# 目标）或手写递归下降（MVP 推荐 ANTLR4 提升速度）；AST 使用不可变记录/类建模。
- **类型检查**: 约束求解（统一/子类型约束），错误定位与友好提示；泛型采用字典传递（早期），后续单态化。
- **IR/字节码**: 简洁三地址码或 SSA-like IR；字节码采用寄存器机设计，指令固定编码，支持调试信息。
- **优化策略**: 起步仅常量折叠/死代码删除；中期引入内联/逃逸分析/负载消除；后期 SSA 与全程序优化。
- **后端优先级**: C 源码生成 > LLVM（LLVMSharp）> WASM（WASI），三者并行验证但不阻塞主线。
- **运行时语言**: 初期小型 runtime 使用 C 或 Rust 编写（内存分配、GC、调度、通道、基础容器），与 AOT/C 后端契合；构建工具与前端使用 C#（你的强项）。
- **FFI/ABI**: C ABI；类型映射规则明确；自动绑定工具（头文件→声明）中期引入。
- **跨平台**: Windows / Linux / macOS；AOT 依赖宿主编译器；WASM 用于受限环境与云侧沙箱。

## 运行时（Runtime）

- **内存管理**: 标记-清扫 GC 起步；后续引入分代/区域/增量/并发 GC；提供逃逸分析配合栈上分配优化。
- **调度器**: 用户态协程/绿色线程；可配置执行器；与 IO 运行时集成（基于 epoll/kqueue/IOCP）。
- **并发原语**: 通道（无缓冲/有缓冲）、select、原子与锁（标准库提供）。
- **错误/异常**: Result 为主；panic/异常仅用于不可恢复错误与 FFI 边界；提供栈追踪与诊断。
- **时间/IO**: 高精度计时器、文件/网络/进程 API；统一异步接口，配合 async/await 语法糖。
- **反射/元编程**: 初期最小化（类型信息与调试符号），中期探索编译期宏/派生。

## 标准库（MVP 范围）

- **核心**: 基础类型、集合（可变/不可变）、字符串、时间、随机、格式化、错误类型。
- **IO**: 文件（读/写/目录）、网络（TCP/UDP/HTTP 客户端最小集）、进程与管道。
- **并发**: 协程、通道、选择、执行器接口。
- **序列化**: JSON（最小），后期加入 MsgPack/CSV/TOML/YAML。
- **加密**: 哈希/对称/非对称的最小集合（调用系统/第三方实现）。
- **正则**: RE2 风格或现成库绑定（性能与 DoS 安全）。
- **测试**: 断言、测试发现、子进程隔离、快照测试（可选）。

## 工具链与开发体验

- **CLI**: `build`、`run`、`fmt`、`lint`、`test`、`bench`、`doc`、`pkg`（包管理）。
- **格式化**: 稳定格式化器（基于 AST），提交前一致性保障。
- **静态检查**: 规范/安全/并发误用规则（分阶段增加）。
- **文档**: 注释→文档生成，站点/离线文档。
- **LSP**: 诊断/补全/跳转/重命名（最小集尽早上线）。
- **包管理**: 语义化版本、锁文件、可重复构建；企业镜像与私有源支持；代理/缓存。

## 安全与健壮性

- **内存安全**: GC + 边界检查；FFI 明确生命周期与所有权规则。
- **并发安全**: 通道优先通信；提供锁/原子；lint 检查常见并发陷阱。
- **输入安全**: 正则/解析限时限量；资源耗尽防护；反序列化白名单。
- **沙箱**: WASM 目标 + WASI 能力边界；策略化权限。
- **供应链安全**: 包签名/哈希校验；源可信策略；SBOM（中期）。

## 性能与基准策略

- **基准套件**: JSON 解析、HTTP echo、并行 map-reduce、矩阵乘、序列/随机 IO、协程上下文切换开销。
- **指标**: 启动时间、峰值吞吐、p99 延迟、内存占用、GC 停顿、二进制大小。
- **方法**: A/B 对比（解释器/字节码/AOT）、火焰图、逃逸分析报告、对象存活期分析。

## 跨平台与分发

- **目标**: Windows / Linux / macOS（x86_64/ARM64）。
- **AOT 分发**: 通过宿主编译器（clang/gcc/MSVC）链接生成本机二进制；静态/动态链接策略按平台优化。
- **WASM**: 生成 `wasm32-wasi`，用于浏览器外部与边缘/云执行；主打安全与隔离。

## 路线图（阶段化里程碑）

- **阶段0（2-4周）**: 规范草拟
  - 产出：EBNF 语法、词法表、类型/求值规则、并发与内存模型草案、MVP 标准库范围、CLI 设计。
- **阶段1（6-10周）**: 解释器原型
  - 产出：Lexer/Parser/AST、类型检查、解释执行、基础 IO/并发原语、`fmt`/`test`、最小 LSP。
- **阶段2（8-12周）**: 字节码 VM
  - 产出：寄存器机字节码、初级优化、GC 初版、并发调度器、基础容器。
- **阶段3（12-20周）**: AOT 与跨平台
  - 产出：C 后端编译链、C ABI FFI、WASM（WASI）基础；可选 LLVM AOT。
- **阶段4（持续）**: 工具链与生态
  - 产出：`pkg` 包管理、`doc`、`bench`、标准库扩充、基准/兼容性矩阵、发布流水线。
- **阶段5（长期）**: 自举
  - 产出：用本语言实现前端/工具链部分，逐步自托管。

## 近期4周行动清单（可执行）

- **第1周**: 冻结 MVP 特性清单与 EBNF；确定基准集合；确定路线：解释器→字节码→AOT（C 后端）。
- **第2周**: 完成 Lexer/Parser/AST；跑通表达式/控制流/函数调用解释执行；实现 `fmt`、`test` CLI 雏形。
- **第3周**: 类型检查与错误报告；Result/Option + `?`；模式匹配（线性规则）；最小 LSP；标准库基础（打印/时间/只读文件）。
- **第4周**: 设计字节码与 VM 骨架；迁移到字节码执行；并发最小实现：`spawn`/`chan`/`select`。

## C# 技术栈映射

- **实现语言**: C#（前端/CLI/LSP），运行时（C/Rust）。
- **解析工具**: ANTLR4（C# 目标）或手写 Parser（递归下降）。
- **IR/后端**: 自研 IR → 生成 C 源码；可选 `LLVMSharp` 接入 LLVM；WASM 生成器与 WASI 运行集成。
- **构建与集成**: dotnet CLI、跨平台构建脚本（PowerShell/ Bash），调用 clang/gcc/MSVC。
- **调试与分析**: PerfView/dotnet-trace（前端工具）、火焰图、GC/逃逸分析日志。

## 风险与应对

- **特性蔓延**: MVP 冻结，迭代中每次新增特性预算受控；通过 RFC 管理变更。
- **性能达标**: 基准先行；每阶段对标与回归；热点驱动优化。
- **GC 停顿**: 以异步 IO/协程调度降低感知；中期引入增量/分代策略。
- **跨平台复杂度**: C 后端优先，LLVM/WASM 并行验证但不阻塞主线。
- **生态冷启动**: 早期提供 C FFI 与绑定生成工具，优先“调用现有库”。

## 版本化与发布

- **版本策略**: 语义化版本；预览/测试/稳定通道；破坏性变更通过 RFC 与迁移指南。
- **发布形式**: 预编译二进制（多平台）、Docker 镜像、WASM 包；安装脚本与校验。
- **兼容策略**: 锁文件与可复现构建；标准库稳定 API 表；弃用周期策略。


