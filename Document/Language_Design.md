## 现代通用编程语言：从0到1技术选型与落地路线

本文档用于沉淀“现代化、完整、独立”的通用编程语言从0到1的技术选型与路线规划，面向 Python / Rust / Go 同级定位。目标：可用于通用开发，具备自有工具链、运行时、标准库、包管理与跨平台能力。

## 愿景与范围

- **愿景**: 提供开发者友好、性能可预期、工具链完善、可跨平台分发的现代语言。
- **范围**: 语言规范、编译/执行管线、运行时、标准库、工具链、包管理、生态分发与安全策略。

## 总体架构与阶段性目标

- **执行路线**: 解释器 → 字节码 VM → LLVM IR → 本机码，并行支持 WASM。
- **内存模型**: 严格所有权系统，基于引用计数和弱引用，仅在必要时进行内存压缩。
- **类型系统**: 静态类型 + 局部推断 + 泛型（初期字典传递，成熟后单态化）。
- **并发模型**: CSP 风格（协程/通道/选择）+ async/await 语法糖。
- **错误处理**: 以 Result/Option 为核心，`?` 传播；异常仅用于不可恢复错误与跨边界桥接。
- **后端目标**: LLVM IR → 本机码（主要路径），并行支持 WASM（WASI）。
- **互操作**: C ABI 优先；提供 `extern` 绑定与自动绑定生成工具（中期）。

## 语言规范（设计基线）

- **语法风格**: C/Go 风格块结构，少关键字，语义直观。
- **模块系统**: 包/模块与命名空间；明确可见性；单一导入语义。
- **类型系统**: 静态类型，类型推断，代数数据类型（ADT），泛型，接口/trait 类能力（后期可做）。
- **并发语义**: 轻量协程、通道、选择（select），背后有可插拔调度器。
- **错误语义**: Result/Option + 模式匹配；异常为宿主/FFI 桥接与崩溃信号。
- **内存语义**: 严格所有权管理，区分所有权和引用；所有权可修改，引用仅观察且接收变更通知；基于引用计数自动释放，避免传统垃圾回收。

## 编译与执行管线（高层）

- **前端**: 词法分析 → 语法分析 → AST 构建 → 语义分析/类型检查。
- **中间层**: 中间表示（IR/字节码）生成与轻量优化（常量折叠、死代码删除、内联等分期推进）。
- **后端（阶段化）**:
  - 阶段1: 解释执行（AST 或简易 IR），快速迭代语义与错误模型。
  - 阶段2: 字节码 VM（寄存器机），基础优化与 GC 集成。
  - 阶段3: LLVM IR 生成与优化，生成本机码；并行支持 WASM 目标。

## 核心技术选型

- **解析**: ANTLR4（C# 目标）或手写递归下降（MVP 推荐 ANTLR4 提升速度）；AST 使用不可变记录/类建模。
- **类型检查**: 约束求解（统一/子类型约束），错误定位与友好提示；泛型采用字典传递（早期），后续单态化。
- **IR/字节码**: 简洁三地址码或 SSA-like IR；字节码采用寄存器机设计，指令固定编码，支持调试信息。
- **优化策略**: 起步仅常量折叠/死代码删除；中期引入内联/逃逸分析/负载消除；后期 SSA 与全程序优化。
- **后端优先级**: LLVM IR（主要）> WASM（WASI），两者并行开发。
- **运行时语言**: 初期小型 runtime 使用 C 或 Rust 编写（内存分配、GC、调度、通道、基础容器），与 LLVM 后端集成；构建工具与前端使用 C#（你的强项）。
- **FFI/ABI**: C ABI；类型映射规则明确；自动绑定工具（头文件→声明）中期引入。
- **跨平台**: Windows / Linux / macOS；LLVM 提供跨平台支持；WASM 用于受限环境与云侧沙箱。

## 运行时（Runtime）

- **内存管理**: 严格所有权系统，基于引用计数和弱引用；栈上分配优化；内存压缩仅在必要时进行；提供逃逸分析配合栈上分配优化。
- **调度器**: 用户态协程/绿色线程；可配置执行器；与 IO 运行时集成（基于 epoll/kqueue/IOCP）。
- **并发原语**: 通道（无缓冲/有缓冲）、select、原子与锁（标准库提供）。
- **错误/异常**: Result 为主；panic/异常仅用于不可恢复错误与 FFI 边界；提供栈追踪与诊断。
- **时间/IO**: 高精度计时器、文件/网络/进程 API；统一异步接口，配合 async/await 语法糖。
- **反射/元编程**: 初期最小化（类型信息与调试符号），中期探索编译期宏/派生。

## 标准库（MVP 范围）

- **核心**: 基础类型、集合（可变/不可变）、字符串、时间、随机、格式化、错误类型。
- **IO**: 文件（读/写/目录）、网络（TCP/UDP/HTTP 客户端最小集）、进程与管道。
- **并发**: 协程、通道、选择、执行器接口。
- **序列化**: JSON（最小），后期加入 MsgPack/CSV/TOML/YAML。
- **加密**: 哈希/对称/非对称的最小集合（调用系统/第三方实现）。
- **正则**: RE2 风格或现成库绑定（性能与 DoS 安全）。
- **测试**: 断言、测试发现、子进程隔离、快照测试（可选）。

## 工具链与开发体验

- **CLI**: `build`、`run`、`fmt`、`lint`、`test`、`bench`、`doc`、`pkg`（包管理）。
- **格式化**: 稳定格式化器（基于 AST），提交前一致性保障。
- **静态检查**: 规范/安全/并发误用规则（分阶段增加）。
- **文档**: 注释→文档生成，站点/离线文档。
- **LSP**: 诊断/补全/跳转/重命名（最小集尽早上线）。
- **包管理**: 语义化版本、锁文件、可重复构建；企业镜像与私有源支持；代理/缓存。

## 安全与健壮性

- **内存安全**: 严格所有权系统 + 边界检查；FFI 明确生命周期与所有权规则。
- **并发安全**: 通道优先通信；提供锁/原子；lint 检查常见并发陷阱。
- **输入安全**: 正则/解析限时限量；资源耗尽防护；反序列化白名单。
- **沙箱**: WASM 目标 + WASI 能力边界；策略化权限。
- **供应链安全**: 包签名/哈希校验；源可信策略；SBOM（中期）。

## 性能与基准策略

- **基准套件**: JSON 解析、HTTP echo、并行 map-reduce、矩阵乘、序列/随机 IO、协程上下文切换开销。
- **指标**: 启动时间、峰值吞吐、p99 延迟、内存占用、内存压缩频率、二进制大小。
- **方法**: A/B 对比（解释器/字节码/AOT）、火焰图、逃逸分析报告、所有权转移分析、引用计数开销分析。

## 跨平台与分发

- **目标**: Windows / Linux / macOS（x86_64/ARM64）。
- **AOT 分发**: 通过 LLVM 工具链生成本机二进制；静态/动态链接策略按平台优化。
- **WASM**: 生成 `wasm32-wasi`，用于浏览器外部与边缘/云执行；主打安全与隔离。

## 路线图（阶段化里程碑）

- **阶段0（2-4周）**: 规范草拟
  - 产出：EBNF 语法、词法表、类型/求值规则、并发与内存模型草案、MVP 标准库范围、CLI 设计。
- **阶段1（6-10周）**: 解释器原型
  - 产出：Lexer/Parser/AST、类型检查、解释执行、基础 IO/并发原语、`fmt`/`test`、最小 LSP。
- **阶段2（8-12周）**: 字节码 VM
  - 产出：寄存器机字节码、初级优化、GC 初版、并发调度器、基础容器。
- **阶段3（12-20周）**: LLVM 后端与跨平台
  - 产出：LLVM IR 生成器、优化 pass、本机码生成、C ABI FFI、WASM（WASI）基础。
- **阶段4（持续）**: 工具链与生态
  - 产出：`pkg` 包管理、`doc`、`bench`、标准库扩充、基准/兼容性矩阵、发布流水线。
- **阶段5（长期）**: 自举
  - 产出：用本语言实现前端/工具链部分，逐步自托管。

## 近期4周行动清单（可执行）

- **第1周**: 冻结 MVP 特性清单与 EBNF；确定基准集合；确定路线：解释器→字节码→LLVM IR。
- **第2周**: 完成 Lexer/Parser/AST；跑通表达式/控制流/函数调用解释执行；实现 `fmt`、`test` CLI 雏形。
- **第3周**: 类型检查与错误报告；Result/Option + `?`；模式匹配（线性规则）；最小 LSP；标准库基础（打印/时间/只读文件）。
- **第4周**: 设计字节码与 VM 骨架；迁移到字节码执行；并发最小实现：`spawn`/`chan`/`select`。

## C# 技术栈映射

- **实现语言**: C#（前端/CLI/LSP），运行时（C/Rust）。
- **解析工具**: ANTLR4（C# 目标）或手写 Parser（递归下降）。
- **IR/后端**: 自研 IR → LLVM IR → 本机码；WASM 生成器与 WASI 运行集成。
- **构建与集成**: dotnet CLI、跨平台构建脚本（PowerShell/ Bash），调用 LLVM 工具链。
- **调试与分析**: PerfView/dotnet-trace（前端工具）、火焰图、GC/逃逸分析日志。

## 风险与应对

- **特性蔓延**: MVP 冻结，迭代中每次新增特性预算受控；通过 RFC 管理变更。
- **性能达标**: 基准先行；每阶段对标与回归；热点驱动优化。
- **内存压缩**: 以异步 IO/协程调度降低感知；中期引入增量压缩策略。
- **跨平台复杂度**: LLVM 后端优先，WASM 并行验证但不阻塞主线。
- **生态冷启动**: 早期提供 C FFI 与绑定生成工具，优先“调用现有库”。

## 版本化与发布

- **版本策略**: 语义化版本；预览/测试/稳定通道；破坏性变更通过 RFC 与迁移指南。
- **发布形式**: 预编译二进制（多平台）、Docker 镜像、WASM 包；安装脚本与校验。
- **兼容策略**: 锁文件与可复现构建；标准库稳定 API 表；弃用周期策略。

 ## 现代语言核心机制图谱（共性 vs 差异化）

下列机制按“通用必备（共性）/ 取舍选型（差异化）/ 典型权衡”组织，便于做产品与工程上的设计决策。

- **执行模型**
  - 共性: 源码到可执行形式（解释/字节码/本机码）的稳定管线；跨平台与调试支持。
  - 差异化: 解释器启动快、实现简单；JIT 灵活但复杂；AOT 性能与分发最佳。
  - 权衡: 迭代速度 vs 峰值性能 vs 工程复杂度（建议解释器→字节码→LLVM IR 渐进）。

- **类型系统**
  - 共性: 基础类型、结构化类型、函数类型、类型推断（不同强度）。
  - 差异化: 静态/动态、强/弱、代数数据类型、泛型实现（单态化/字典传递）、trait/接口。
  - 权衡: 可表达性与学习曲线、编译时长与运行性能、IDE 体验与实现复杂度。

- **内存管理**
  - 共性: 清晰的所有权/生命周期或自动托管模型，避免悬挂引用与双重释放。
  - 差异化: 严格所有权系统（引用计数+弱引用）、传统GC（分代/并发/区域）、引用计数（ARC/RC+弱引用）。
  - 权衡: 开发效率 vs 延迟/吞吐；内存压缩频率（所有权） vs 心智负担（传统GC）。

- **并发与异步**
  - 共性: 任务/线程抽象、同步原语（锁/原子/条件变量）或更高级别的通信机制。
  - 差异化: CSP（协程+通道+select）、async/await 模型、Actor 模型、绿色线程/调度器。
  - 权衡: 可组合性 vs 可控性；易用性 vs 可预期性能；跨平台 IO 模型兼容性。

- **错误处理**
  - 共性: 可区分可恢复与不可恢复错误；可观测性（日志/堆栈/诊断）。
  - 差异化: 异常（栈展开） vs 结果类型（`Result/Option` + 模式匹配）；`?` 传播糖。
  - 权衡: API 噪声（Result） vs 隐式控制流（异常）；FFI/ABI 与跨边界行为复杂度。

- **模块与包管理**
  - 共性: 模块/命名空间、可见性、依赖解析、语义版本、锁文件、可复现构建。
  - 差异化: 单一 GOPATH/模块文件风（Go） vs 清单+锁（Cargo/npm 风）；集中/去中心仓库。
  - 权衡: 简洁 UX vs 灵活策略；企业私有源与缓存镜像支持的工程复杂度。

- **标准库与运行时能力**
  - 共性: 容器、字符串、时间、IO/网络、并发原语、序列化、加密。
  - 差异化: 运行时大小与“电池全含”程度；反射/元编程能力；跨平台抽象深度。
  - 权衡: 生态冷启动（多给 std 功能） vs 体积与维护成本；安全基线与 DoS 风险。

- **FFI/ABI 与互操作**
  - 共性: 与 C ABI 互通；明确的调用约定、内存语义、错误传播约定。
  - 差异化: 自动绑定生成（头文件/IDL）、多语言桥（Python/Rust/JS），WASM ABI。
  - 权衡: 互操作广度 vs 复杂度/安全性；零拷贝与生命周期管理成本。

- **安全模型**
  - 共性: 边界检查、内存安全保障、输入限流/沙箱策略。
  - 差异化: 类型系统强化（不可变/线性/能力安全）、权限模型（WASI 能力）、包供应链签名。
  - 权衡: 性能与易用性；开发效率与形式化保证的投入比例。

- **调试与可观测性**
  - 共性: 栈追踪、断点/单步、日志级别、性能剖析（CPU/内存/锁）。
  - 差异化: 语言级时间旅行调试、逃逸分析报告、可视化 GC/调度器指标。
  - 权衡: 运行时开销与开发体验；生产可观测性与隐私/合规。

- **构建与分发**
  - 共性: 跨平台构建、版本与渠道管理、重现式产物。
  - 差异化: 单文件静态发布、增量编译、远程缓存、WASM 分发与沙箱运行。
  - 权衡: 产物体积/启动速度/链接复杂度；供应链与镜像可靠性。

- **特性化亮点（差异化方向）**
  - 高层并发：CSP + 可组合 `select`，或 Actor 与持久化邮箱。
  - 类型系统：一等 ADT + 模式匹配 + 类型类/trait 派生；效果系统/可验证并发（中长期）。
  - 性能路径：LLVM IR + 逃逸分析 + 栈上分配 + 无锁容器；增量/并发内存压缩。
  - 生态桥：优先级高的 C FFI + 自动绑定；WASM 一等公民与策略化权限。
  - DX：稳定格式化器、强 LSP、`test/bench/doc/pkg` 一体化；优秀错误信息与修复建议。



